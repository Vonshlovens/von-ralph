#!/usr/bin/env bash
set -o pipefail

if ! command -v jq &>/dev/null; then
  echo "Error: jq is not installed. Install it with: sudo apt install jq"
  exit 1
fi

DEFAULT_PROMPT='/tackle choose a todo. If you come across tasks that go out of scope of the todo, make new kanban todos.

Update specs if needed â€” they are the current source of truth. Rules:

1. NEVER delete planned feature descriptions, API designs, or architectural blueprints from specs. If something isn'\''t implemented yet, mark it as "Planned" â€” don'\''t remove it. The design detail is the whole point.

2. DO fix stale file paths, wrong component names, and inaccurate descriptions of *implemented* code.

3. If you touch a spec, clearly separate "Implemented" sections from "Planned" sections so the next agent knows what exists vs what'\''s designed but not built.

4. If something is impossible to implement or has conflicting instructions, research current practices and fix the discrepancy â€” but preserve the design intent.

5. Never remove cross-references between specs, even to planned sections â€” mark them as "(Planned)" instead.

When you are done, ensure you have added at least one (1) new todo to the kanban.'

PROMPT="${1:-$DEFAULT_PROMPT}"
RATE_LIMIT_SLEEP=1800  # 30 minutes

cleanup() {
  echo " Stopped."
  pkill -TERM -P $$ 2>/dev/null
  sleep 0.1
  pkill -KILL -P $$ 2>/dev/null
  exit 0
}

trap cleanup INT TERM

while true; do
  OUTPUT=$(claude -p --model=opus --dangerously-skip-permissions \
    "$PROMPT" \
    --print --output-format=stream-json --verbose </dev/null 2>/dev/null \
  | jq -r '
    if .type == "assistant" then
      .message.content[]? |
      if .type == "text" then
        "ðŸ’¬ " + .text
      elif .type == "tool_use" then
        "ðŸ”§ " + .name + ": " + (.input | tostring | .[0:150])
      else empty end
    elif .type == "user" then
      .message.content[]? |
      if .type == "tool_result" then
        "ðŸ“‹ " + (.content | tostring | .[0:200])
      else empty end
    else empty end
  ')

  echo "$OUTPUT"
  echo "--- RUN COMPLETE ---"

  if echo "$OUTPUT" | grep -q "You've hit your limit"; then
    echo "â³ Rate limited. Sleeping 30 minutes ($(date -d '+30 minutes' '+%H:%M:%S' 2>/dev/null || date -v+30M '+%H:%M:%S' 2>/dev/null || echo '~30m from now'))..."
    sleep "$RATE_LIMIT_SLEEP" &
    wait $!
  else
    sleep 2 &
    wait $!
  fi
done
