#!/usr/bin/env bash
set -o pipefail

if ! command -v jq &>/dev/null; then
  echo "Error: jq is not installed. Install it with: sudo apt install jq"
  exit 1
fi

DEFAULT_PROMPT='You are an expert developer operating in a headless loop (RALPH). Your goal is to implement the project defined in the /specs directory by executing one atomic task at a time.

<Context>
- SPECS: Read all files in /specs to understand architecture.
- KANBAN: Use '\''kanban.yaml'\''. This is your persistent memory across loop iterations.
</Context>

<Kanban_Protocol>
1. READ '\''kanban.yaml'\'' immediately.
2. IF '\''todo'\'' is empty AND '\''in_progress'\'' is empty:
   - Analyze the specs and populate the '\''todo'\'' list with the first 3-5 atomic technical steps required to start the project.
3. SELECT the top item from '\''todo'\''. Move it to '\''in_progress'\''.
4. UPDATE the '\''metadata'\'' field in the YAML:
   - set '\''last_agent_status'\'' to "Starting task: [task name]"
</Kanban_Protocol>

<Execution_Rules>
- Focus ONLY on the single task in '\''in_progress'\''.
- Do not "hallucinate" completion; verify changes with `ls`, `cat`, or test commands.
- If you realize a task is too big, split it. Add the sub-tasks to the TOP of the '\''todo'\'' list.
- If you find a bug or a missing requirement for later, add it to '\''backlog'\''.
</Execution_Rules>

<Handoff_and_Termination>
Once the task is implemented and verified:
1. Move the task from '\''in_progress'\'' to '\''done'\''.
2. Update '\''kanban.yaml'\'' with a '\''handoff'\'' field:
   - '\''handoff'\'': "Brief summary of what was implemented and what the next agent should look out for."
3. If the '\''todo'\'' list is now empty and the project matches the specs, set '\''status'\'' to "PROJECT_COMPLETE".
4. Say "TASK_COMPLETE" and exit.
</Handoff_and_Termination>

Begin by reading '\''kanban.yaml'\''.'

PROMPT="${1:-$DEFAULT_PROMPT}"
RATE_LIMIT_SLEEP=1800  # 30 minutes

cleanup() {
  echo " Stopped."
  pkill -TERM -P $$ 2>/dev/null
  sleep 0.1
  pkill -KILL -P $$ 2>/dev/null
  exit 0
}

trap cleanup INT TERM

while true; do
  OUTPUT=$(claude -p --model=opus --dangerously-skip-permissions \
    "$PROMPT" \
    --print --output-format=stream-json --verbose </dev/null 2>/dev/null \
  | jq -r '
    if .type == "assistant" then
      .message.content[]? |
      if .type == "text" then
        "ðŸ’¬ " + .text
      elif .type == "tool_use" then
        "ðŸ”§ " + .name + ": " + (.input | tostring | .[0:150])
      else empty end
    elif .type == "user" then
      .message.content[]? |
      if .type == "tool_result" then
        "ðŸ“‹ " + (.content | tostring | .[0:200])
      else empty end
    else empty end
  ')

  echo "$OUTPUT"
  echo "--- RUN COMPLETE ---"

  if echo "$OUTPUT" | grep -q "You've hit your limit"; then
    echo "â³ Rate limited. Sleeping 30 minutes ($(date -d '+30 minutes' '+%H:%M:%S' 2>/dev/null || date -v+30M '+%H:%M:%S' 2>/dev/null || echo '~30m from now'))..."
    sleep "$RATE_LIMIT_SLEEP" &
    wait $!
  else
    sleep 2 &
    wait $!
  fi
done
