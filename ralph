#!/usr/bin/env bash
set -o pipefail

if ! command -v jq &>/dev/null; then
  echo "Error: jq is not installed. Install it with: sudo apt install jq"
  exit 1
fi

if [ -z "$1" ]; then
  echo "Usage: ralph <prompt>"
  exit 1
fi

PROMPT="$1"

cleanup() {
  echo " Stopped."
  pkill -TERM -P $$ 2>/dev/null
  sleep 0.1
  pkill -KILL -P $$ 2>/dev/null
  exit 0
}

trap cleanup INT TERM

while true; do
  claude -p --model=opus --dangerously-skip-permissions \
    "$PROMPT" \
    --print --output-format=stream-json --verbose </dev/null 2>/dev/null \
  | jq -r '
    if .type == "assistant" then
      .message.content[]? |
      if .type == "text" then
        "ðŸ’¬ " + .text
      elif .type == "tool_use" then
        "ðŸ”§ " + .name + ": " + (.input | tostring | .[0:150])
      else empty end
    elif .type == "user" then
      .message.content[]? |
      if .type == "tool_result" then
        "ðŸ“‹ " + (.content | tostring | .[0:200])
      else empty end
    else empty end
  ' &
  wait $!
  echo "--- RUN COMPLETE ---"
  sleep 2 &
  wait $!
done
